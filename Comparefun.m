
function dx=Comparefun(t,x)

m1=0.765;m2=0.765;  
l1=0.25;l2=0.25; 
r1=0.15;r2=0.15; 

J1=4/3*m1*r1^2+m2*11^2;
J2=4/3*m2*r2^2;

%参考信号
  r11=1*sin(t);
  dr11=1*cos(t);   
  r21=1*sin(t);
  dr21=1*cos(t);   
  yd=[r11;r21];
  dyd=[dr11;dr21]; 

q1=x(1);q2=x(2);
dq1=x(3);dq2=x(4);

x1=[q1;q2];
x2=[dq1;dq2];

M11=J1+J2+2*m2*r2*11*cos(q2);
M12=J2+m2*r2*11*cos(q2);
M21=M12;
M22=J2;

M=[M11 M12;
   M21 M22]; 

C11=-2*m2*r2*11*dq2*sin(q2); 
C12=-m2*r2*11*dq2*sin(q2);
C21=m2*r2*l1*dq1*sin(q2);
C22=0;
C=[C11 C12; C21 C22]; 

%外界干扰
d=[0.025*sin(t) 0.025*sin(t)]';


 %estimate of x
 a1(1)=exp(-(x(1)-4)^2/2);
 a1(2)=exp(-(x(1)-2)^2/2);
 a1(3)=exp(-(x(1))^2/2);
 a1(4)=exp(-(x(1)+2)^2/2);
 a1(5)=exp(-(x(1)+4)^2/2);
 a1=a1/sum(a1);
 
 b1(1)=exp(-(x(2)-4)^2/2)*exp(-(x(1)-4)^2/2);
 b1(2)=exp(-(x(2)-2)^2/2)*exp(-(x(1)-2)^2/2);
 b1(3)=exp(-(x(2))^2/2)*exp(-(x(1))^2/2);
 b1(4)=exp(-(x(2)+2)^2/2)*exp(-(x(1)+2)^2/2);
 b1(5)=exp(-(x(2)+4)^2/2)*exp(-(x(1)+4)^2/2);
 b1=b1/sum(b1);
 
 theta1=[x(5) x(6) x(7) x(8) x(9)];
 theta2=[x(10) x(11) x(12) x(13) x(14)];

%FDI attacks
if  t>=15
    a1=0;%sin(t)+0.5;
else
    a1=0;
end

if  t>=14
    a11=0;%1.7451-1.6265*exp(-(0.8326*sqrt((0-t).^2 )).^2 )+0.1474*exp(-(0.8326*sqrt((0.8-t).^2 )).^2 )-1.2222*exp(-(0.8326*sqrt((1.6-t).^2 )).^2 )-0.2793*exp(-(0.8326*sqrt((2.4-t).^2 )).^2 )-0.8993*exp(-(0.8326*sqrt((3.2-t).^2 )).^2 )-0.5014*exp(-(0.8326*sqrt((4-t).^2 )).^2 )-0.7504*exp(-(0.8326*sqrt((4.8-t).^2 )).^2 )-0.6021*exp(-(0.8326*sqrt((5.6-t).^2 )).^2 )-0.6790*exp(-(0.8326*sqrt((6.4-t).^2 )).^2 )-0.6582*exp(-(0.8326*sqrt((7.2-t).^2 )).^2 )-0.6270*exp(-(0.8326*sqrt((8-t).^2 )).^2 )-0.7165*exp(-(0.8326*sqrt((8.8-t).^2 )).^2 )-0.5509*exp(-(0.8326*sqrt((9.6-t).^2 )).^2 )-0.8256*exp(-(0.8326*sqrt((10.4-t).^2 )).^2 )-0.3872*exp(-(0.8326*sqrt((11.2-t).^2 )).^2 )-1.0759*exp(-(0.8326*sqrt((12-t).^2 )).^2 )-0.0034*exp(-(0.8326*sqrt((12.8-t).^2 )).^2 )-1.6580*exp(-(0.8326*sqrt((13.6-t).^2 )).^2 )+0.8493*exp(-(0.8326*sqrt((14.4-t).^2 )).^2 )-2.7951*exp(-(0.8326*sqrt((15.2-t).^2 )).^2 )+1.9918*exp(-(0.8326*sqrt((16-t).^2 )).^2 )-2.9293*exp(-(0.8326*sqrt((16.8-t).^2 )).^2 )+0.3802*exp(-(0.8326*sqrt((17.6-t).^2 )).^2 )-1.5981*exp(-(0.8326*sqrt((18.4-t).^2 )).^2 )+0.2985*exp(-(0.8326*sqrt((19.2-t).^2 )).^2 )-0.3505*exp(-(0.8326*sqrt((20-t).^2 )).^2 )+0.2736*exp(-(0.8326*sqrt((20.8-t).^2 )).^2 )-0.4171*exp(-(0.8326*sqrt((21.6-t).^2 )).^2 )-0.5828*exp(-(0.8326*sqrt((22.4-t).^2 )).^2 )-1.0357*exp(-(0.8326*sqrt((23.2-t).^2 )).^2 )-0.9150*exp(-(0.8326*sqrt((24-t).^2 )).^2 )-0.6702*exp(-(0.8326*sqrt((24.8-t).^2 )).^2 )-0.2082*exp(-(0.8326*sqrt((25.6-t).^2 )).^2 )+0.0357*exp(-(0.8326*sqrt((26.4-t).^2 )).^2 )+0.0130*exp(-(0.8326*sqrt((27.2-t).^2 )).^2 )-0.3263*exp(-(0.8326*sqrt((28-t).^2 )).^2 )-0.7355*exp(-(0.8326*sqrt((28.8-t).^2 )).^2 )-0.9926*exp(-(0.8326*sqrt((29.6-t).^2 )).^2 )-0.9248*exp(-(0.8326*sqrt((30.4-t).^2 )).^2 )-0.5841*exp(-(0.8326*sqrt((31.2-t).^2 )).^2 )-0.1702*exp(-(0.8326*sqrt((32-t).^2 )).^2 )+0.0614*exp(-(0.8326*sqrt((32.8-t).^2 )).^2 )-0.0269*exp(-(0.8326*sqrt((33.6-t).^2 )).^2 )-0.3834*exp(-(0.8326*sqrt((34.4-t).^2 )).^2 )-0.7907*exp(-(0.8326*sqrt((35.2-t).^2 )).^2 )-1.0025*exp(-(0.8326*sqrt((36-t).^2 )).^2 )-0.8897*exp(-(0.8326*sqrt((36.8-t).^2 )).^2 )-0.5212*exp(-(0.8326*sqrt((37.6-t).^2 )).^2 )-0.1203*exp(-(0.8326*sqrt((38.4-t).^2 )).^2 )+0.0698*exp(-(0.8326*sqrt((39.2-t).^2 )).^2 )-0.0663*exp(-(0.8326*sqrt((40-t).^2 )).^2 )-0.4459*exp(-(0.8326*sqrt((40.8-t).^2 )).^2 )-0.8389*exp(-(0.8326*sqrt((41.6-t).^2 )).^2 )-1.0068*exp(-(0.8326*sqrt((42.4-t).^2 )).^2 )-0.8478*exp(-(0.8326*sqrt((43.2-t).^2 )).^2 )-0.4583*exp(-(0.8326*sqrt((44-t).^2 )).^2 )-0.0746*exp(-(0.8326*sqrt((44.8-t).^2 )).^2 )+0.0705*exp(-(0.8326*sqrt((45.6-t).^2 )).^2 )-0.1109*exp(-(0.8326*sqrt((46.4-t).^2 )).^2 )-0.5088*exp(-(0.8326*sqrt((47.2-t).^2 )).^2 )-0.8819*exp(-(0.8326*sqrt((48-t).^2 )).^2 )-1.0039*exp(-(0.8326*sqrt((48.8-t).^2 )).^2 )-0.8006*exp(-(0.8326*sqrt((49.6-t).^2 )).^2 )-0.3956*exp(-(0.8326*sqrt((50.4-t).^2 )).^2 )-0.0344*exp(-(0.8326*sqrt((51.2-t).^2 )).^2 )+0.0639*exp(-(0.8326*sqrt((52-t).^2 )).^2 )-0.1604*exp(-(0.8326*sqrt((52.8-t).^2 )).^2 )-0.5712*exp(-(0.8326*sqrt((53.6-t).^2 )).^2 )-0.9193*exp(-(0.8326*sqrt((54.5-t).^2 )).^2 )-0.9936*exp(-(0.8326*sqrt((55.2-t).^2 )).^2 )-0.7490*exp(-(0.8326*sqrt((56-t).^2 )).^2 )-0.3338*exp(-(0.8326*sqrt((56.8-t).^2 )).^2 )-0*exp(-(0.8326*sqrt((57.6-t).^2 )).^2 )+0.0500*exp(-(0.8326*sqrt((58.4-t).^2 )).^2 )-0.2141*exp(-(0.8326*sqrt((59.2-t).^2 )).^2 )-0.6321*exp(-(0.8326*sqrt((60-t).^2 )).^2 )-0.9506*exp(-(0.8326*sqrt((60.8-t).^2 )).^2 )-0.9761*exp(-(0.8326*sqrt((61.6-t).^2 )).^2 )-0.6936*exp(-(0.8326*sqrt((62.4-t).^2 )).^2 )-0.2737*exp(-(0.8326*sqrt((63.2-t).^2 )).^2 )+0.0278*exp(-(0.8326*sqrt((64-t).^2 )).^2 )+0.0295*exp(-(0.8326*sqrt((64.8-t).^2 )).^2 )-0.2718*exp(-(0.8326*sqrt((65.6-t).^2 )).^2 )-0.6900*exp(-(0.8326*sqrt((66.4-t).^2 )).^2 )-0.9766*exp(-(0.8326*sqrt((67.2-t).^2 )).^2 )-0.9497*exp(-(0.8326*sqrt((68-t).^2 )).^2 )-0.6382*exp(-(0.8326*sqrt((68.8-t).^2 )).^2 )-0.2114*exp(-(0.8326*sqrt((69.6-t).^2 )).^2 )+0.0411*exp(-(0.8326*sqrt((70.4-t).^2 )).^2 )+0.0140*exp(-(0.8326*sqrt((71.2-t).^2 )).^2 )-0.3507*exp(-(0.8326*sqrt((72-t).^2 )).^2 )-0.7159*exp(-(0.8326*sqrt((72.8-t).^2 )).^2 )-1.0407*exp(-(0.8326*sqrt((73.6-t).^2 )).^2 )-0.8464*exp(-(0.8326*sqrt((74.4-t).^2 )).^2 )-0.6899*exp(-(0.8326*sqrt((75.2-t).^2 )).^2 )+0.0174*exp(-(0.8326*sqrt((76-t).^2 )).^2 )-0.2157*exp(-(0.8326*sqrt((76.8-t).^2 )).^2 )+0.3962*exp(-(0.8326*sqrt((77.6-t).^2 )).^2 )-1.0383*exp(-(0.8326*sqrt((78.4-t).^2 )).^2 )+0.1243*exp(-(0.8326*sqrt((79.2-t).^2 )).^2 )-2.1498*exp(-(0.8326*sqrt((80-t).^2 )).^2 );
else
    a11=0;
end

if  t>=15
    a2=0;%1*(x(3).*cos(x(3)));
else
    a2=0;
end

if  t>=14
    a22=0;%1*(-5.0616*exp(-(0.8326*sqrt((-10.0000-x(3)).^2 )).^2 )+24.2790*exp(-(0.8326*sqrt((-9.5000-x(3)).^2 )).^2 )-33.1087*exp(-(0.8326*sqrt((-9.0000-x(3)).^2 )).^2 )+45.1865*exp(-(0.8326*sqrt((-8.5000-x(3)).^2 )).^2 )-48.9121*exp(-(0.8326*sqrt((-8.0000-x(3)).^2 )).^2 )+46.9111*exp(-(0.8326*sqrt((-7.5000-x(3)).^2 )).^2 )-48.7051*exp(-(0.8326*sqrt((-7.0000-x(3)).^2 )).^2 )+39.3849*exp(-(0.8326*sqrt((-6.5000-x(3)).^2 )).^2 )-40.0842*exp(-(0.8326*sqrt((-6.0000-x(3)).^2 )).^2 )+31.1584*exp(-(0.8326*sqrt((-5.5000-x(3)).^2 )).^2 )-29.3223*exp(-(0.8326*sqrt((-5.0000-x(3)).^2 )).^2 )+24.3382*exp(-(0.8326*sqrt((-4.5000-x(3)).^2 )).^2 )-20.3287*exp(-(0.8326*sqrt((-4.0000-x(3)).^2 )).^2 )+18.1861*exp(-(0.8326*sqrt((-3.5000-x(3)).^2 )).^2 )-14.5207*exp(-(0.8326*sqrt((-3.0000-x(3)).^2 )).^2 )+12.4304*exp(-(0.8326*sqrt((-2.5000-x(3)).^2 )).^2 )-11.0563*exp(-(0.8326*sqrt((-2.0000-x(3)).^2 )).^2 )+7.8850*exp(-(0.8326*sqrt((-1.5000-x(3)).^2 )).^2 )-8.3089*exp(-(0.8326*sqrt((-1.0000-x(3)).^2 )).^2 )+5.1688*exp(-(0.8326*sqrt((-0.5000-x(3)).^2 )).^2 )-5.5822*exp(-(0.8326*sqrt((-0.0000-x(3)).^2 )).^2 )+3.6819*exp(-(0.8326*sqrt((0.5000-x(3)).^2 )).^2 )-3.4479*exp(-(0.8326*sqrt((1.0000-x(3)).^2 )).^2 )+2.1656*exp(-(0.8326*sqrt((1.5000-x(3)).^2 )).^2 )-2.5379*exp(-(0.8326*sqrt((2.0000-x(3)).^2 )).^2 )+0.1387*exp(-(0.8326*sqrt((2.5000-x(3)).^2 )).^2 )-2.3290*exp(-(0.8326*sqrt((3.0000-x(3)).^2 )).^2 )-1.5599*exp(-(0.8326*sqrt((3.5000-x(3)).^2 )).^2 )-1.4459*exp(-(0.8326*sqrt((4.0000-x(3)).^2 )).^2 )-1.8640*exp(-(0.8326*sqrt((4.5000-x(3)).^2 )).^2 )+0.7537*exp(-(0.8326*sqrt((5.0000-x(3)).^2 )).^2 )-0.9896*exp(-(0.8326*sqrt((5.5000-x(3)).^2 )).^2 )+3.0914*exp(-(0.8326*sqrt((6.0000-x(3)).^2 )).^2 )-0.4454*exp(-(0.8326*sqrt((6.5000-x(3)).^2 )).^2 )+3.3099*exp(-(0.8326*sqrt((7.0000-x(3)).^2 )).^2 )-1.1255*exp(-(0.8326*sqrt((7.5000-x(3)).^2 )).^2 )+0*exp(-(0.8326*sqrt((8.0000-x(3)).^2 )).^2 )-1.5164*exp(-(0.8326*sqrt((8.5000-x(3)).^2 )).^2 )-5.7167*exp(-(0.8326*sqrt((9.0000-x(3)).^2 )).^2 )+0.2718*exp(-(0.8326*sqrt((9.5000-x(3)).^2 )).^2 )-8.0533*exp(-(0.8326*sqrt((10.0000-x(3)).^2 )).^2 )+2.6196);
else
    a22=0;
end

%Actuator attacks
if  t>=10
    a3=0;%1*(x(3).*cos(x(3)));
else
    a3=0;
end

if  t>=7
    a33=0;%1*(-5.0616*exp(-(0.8326*sqrt((-10.0000-x(3)).^2 )).^2 )+24.2790*exp(-(0.8326*sqrt((-9.5000-x(3)).^2 )).^2 )-33.1087*exp(-(0.8326*sqrt((-9.0000-x(3)).^2 )).^2 )+45.1865*exp(-(0.8326*sqrt((-8.5000-x(3)).^2 )).^2 )-48.9121*exp(-(0.8326*sqrt((-8.0000-x(3)).^2 )).^2 )+46.9111*exp(-(0.8326*sqrt((-7.5000-x(3)).^2 )).^2 )-48.7051*exp(-(0.8326*sqrt((-7.0000-x(3)).^2 )).^2 )+39.3849*exp(-(0.8326*sqrt((-6.5000-x(3)).^2 )).^2 )-40.0842*exp(-(0.8326*sqrt((-6.0000-x(3)).^2 )).^2 )+31.1584*exp(-(0.8326*sqrt((-5.5000-x(3)).^2 )).^2 )-29.3223*exp(-(0.8326*sqrt((-5.0000-x(3)).^2 )).^2 )+24.3382*exp(-(0.8326*sqrt((-4.5000-x(3)).^2 )).^2 )-20.3287*exp(-(0.8326*sqrt((-4.0000-x(3)).^2 )).^2 )+18.1861*exp(-(0.8326*sqrt((-3.5000-x(3)).^2 )).^2 )-14.5207*exp(-(0.8326*sqrt((-3.0000-x(3)).^2 )).^2 )+12.4304*exp(-(0.8326*sqrt((-2.5000-x(3)).^2 )).^2 )-11.0563*exp(-(0.8326*sqrt((-2.0000-x(3)).^2 )).^2 )+7.8850*exp(-(0.8326*sqrt((-1.5000-x(3)).^2 )).^2 )-8.3089*exp(-(0.8326*sqrt((-1.0000-x(3)).^2 )).^2 )+5.1688*exp(-(0.8326*sqrt((-0.5000-x(3)).^2 )).^2 )-5.5822*exp(-(0.8326*sqrt((-0.0000-x(3)).^2 )).^2 )+3.6819*exp(-(0.8326*sqrt((0.5000-x(3)).^2 )).^2 )-3.4479*exp(-(0.8326*sqrt((1.0000-x(3)).^2 )).^2 )+2.1656*exp(-(0.8326*sqrt((1.5000-x(3)).^2 )).^2 )-2.5379*exp(-(0.8326*sqrt((2.0000-x(3)).^2 )).^2 )+0.1387*exp(-(0.8326*sqrt((2.5000-x(3)).^2 )).^2 )-2.3290*exp(-(0.8326*sqrt((3.0000-x(3)).^2 )).^2 )-1.5599*exp(-(0.8326*sqrt((3.5000-x(3)).^2 )).^2 )-1.4459*exp(-(0.8326*sqrt((4.0000-x(3)).^2 )).^2 )-1.8640*exp(-(0.8326*sqrt((4.5000-x(3)).^2 )).^2 )+0.7537*exp(-(0.8326*sqrt((5.0000-x(3)).^2 )).^2 )-0.9896*exp(-(0.8326*sqrt((5.5000-x(3)).^2 )).^2 )+3.0914*exp(-(0.8326*sqrt((6.0000-x(3)).^2 )).^2 )-0.4454*exp(-(0.8326*sqrt((6.5000-x(3)).^2 )).^2 )+3.3099*exp(-(0.8326*sqrt((7.0000-x(3)).^2 )).^2 )-1.1255*exp(-(0.8326*sqrt((7.5000-x(3)).^2 )).^2 )+0*exp(-(0.8326*sqrt((8.0000-x(3)).^2 )).^2 )-1.5164*exp(-(0.8326*sqrt((8.5000-x(3)).^2 )).^2 )-5.7167*exp(-(0.8326*sqrt((9.0000-x(3)).^2 )).^2 )+0.2718*exp(-(0.8326*sqrt((9.5000-x(3)).^2 )).^2 )-8.0533*exp(-(0.8326*sqrt((10.0000-x(3)).^2 )).^2 )+2.6196);
else
    a33=0;
end

a3=[a3;a3];

x3=[x(15);x(16)];

x4=[x(17);x(18)];
x5=[x(19);x(20)];
% %with attack compensation
% x1piao=[q1+a1-a11;q2+a1-a11];
% x2piao=[dq1+a2-a22;dq2+a2-a22];

%without attack compensation
x1piaono=[q1+a1;q2+a1];
x2piaono=[dq1+a2;dq2+a2];

 c1=50; c2=15;
 
 gama1=0.2;
 cigema1=0.01;
 gama2=0.2;
 cigema2=0.01;
 
 tao=1;

%estimation function
Ia=[a1;a1;a1;a1;a1];
Ib=[b1;b1;b1;b1;b1];
f1hat=[theta1*Ia;theta1*Ia];
f2hat=[theta2*Ib;theta2*Ib];
%estimation attack
a1hat=[a11;a11];
a2hat=[a22;a22];

% %with attack compensation
% y=x1;
% z1=y-yd;
% z1hat=x1piao-yd;
% alfal =-c1*z1hat-3*z1hat-a1hat-f1hat+dyd;
% 
% z2=x2-x3;
% kama=x3-alfal;
% z2hat=x2piao-alfal;
% u=-c2*z2hat-3*z2hat-a2hat-f1hat-kama/tao;
% u1=-[1 0]*c2*z2hat-[1 0]*3*z2hat-[1 0]*a2hat-[1 0]*f1hat-[1 0]*kama/tao;
% u2=-[0 1]*c2*z2hat-[0 1]*3*z2hat-[0 1]*a2hat-[0 1]*f1hat-[0 1]*kama/tao;

%without attack compensation
y=x1;
z1=y-yd;
z1hat=x1piaono-yd;
alfal =-c1*z1hat-3*z1hat-f1hat+dyd;

z2=x2-x3;
kama=x3-alfal;
z2hat=x2piaono-alfal;
u=-c2*z2hat-3*z2hat-f1hat-kama/tao-a3;
u1=-[1 0]*c2*z2hat-[1 0]*3*z2hat-[1 0]*f1hat-[1 0]*kama/tao-[1 0]*a3;
u2=-[0 1]*c2*z2hat-[0 1]*3*z2hat-[0 1]*f1hat-[0 1]*kama/tao-[0 1]*a3;

%Actuator attacks
if  t>=10 && t<=20 | t>=30 && t<=40;
    v1=0.1*u1;%1*(x(3).*cos(x(3)));
else
    v1=u1;
end
if  t>=10 && t<=20 | t>=30 && t<=40;
    v2=0.1*u2;%1*(x(3).*cos(x(3)));
else
    v2=u2;
end

v=[v1;v2];


dx=[x(3); 
    x(4);
    -inv(M)*C*[dq1;dq2]+inv(M)*(v-d);
    
    gama1*[x(5) x(6) x(7) x(8) x(9)]'+cigema1*theta1';
    -gama2*[x(10) x(11) x(12) x(13) x(14)]'+cigema2*theta2';
    
    -kama/tao;
    -kama/tao;
    x(3); 
    x(4);
    -inv(M)*C*[dq1;dq2]+inv(M)*(u-[a33; a33]-d);];
   
   
   
    
%  +B1/M*x(2)^2*x(3)^3
%  -R/L*x(2)^2*sin(x(3))

    
